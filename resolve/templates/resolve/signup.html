{% extends 'resolve/base.html' %}

{% block title %}Sign Up - MyCity Resolve{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h2 class="mb-4"><i class="fas fa-user-plus text-primary"></i> Create your account</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Account Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label" for="id_username">Username</label>
                        {{ form.username }}
                        {{ form.username.errors }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="id_real_name">Full Name</label>
                        {{ form.real_name }}
                        {{ form.real_name.errors }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="id_contact_email">Email</label>
                        {{ form.contact_email }}
                        {{ form.contact_email.errors }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="id_password1">Password</label>
                        {{ form.password1 }}
                        {{ form.password1.errors }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="id_password2">Confirm Password</label>
                        {{ form.password2 }}
                        {{ form.password2.errors }}
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Your Location</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="location-search" class="form-label">Search Your Hometown</label>
                        <div class="input-group">
                            <input type="text" id="location-search" class="form-control" placeholder="Enter your hometown (e.g., Kolhapur)">
                            <button class="btn btn-primary" type="button" id="search-button">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <p class="text-muted">Click on the map to refine your exact location if needed.</p>
                    <div id="map" class="map-container mb-3"></div>
                    {{ form.hometown_name }}
                    {{ form.hometown_latitude }}
                    {{ form.hometown_longitude }}

                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'login' %}">Already have an account? Log in</a>
                <button type="submit" class="btn btn-primary">Sign Up</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-container {
        height: 300px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    #location-search {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    #search-button {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
</style>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let marker;
    let defaultLat = 16.7050; // Kolhapur coordinates as default
    let defaultLng = 74.2433;

    async function searchLocation(query) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                const location = data[0];
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                
                // Update map and marker
                map.setView([lat, lon], 13);
                marker.setLatLng([lat, lon]);
                
                // Update hidden form fields
                document.getElementById("id_hometown_latitude").value = lat;
                document.getElementById("id_hometown_longitude").value = lon;
                document.getElementById("id_hometown_name").value = location.display_name;
            } else {
                alert("Location not found. Please try a different search term.");
            }
        } catch (error) {
            console.error("Error searching location:", error);
            alert("Error searching location. Please try again.");
        }
    }

    function initMap() {
        // Initialize the map using Leaflet (OpenStreetMap)
        map = L.map('map').setView([defaultLat, defaultLng], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Create a marker
        marker = L.marker([defaultLat, defaultLng], {
            draggable: true
        }).addTo(map);

        // Update coordinates when marker is dragged
        marker.on('dragend', function(event) {
            const position = event.target.getLatLng();
            document.getElementById("id_hometown_latitude").value = position.lat;
            document.getElementById("id_hometown_longitude").value = position.lng;
        });

        // Update coordinates when map is clicked
        map.on('click', function(event) {
            const lat = event.latlng.lat;
            const lng = event.latlng.lng;
            
            marker.setLatLng([lat, lng]);
            document.getElementById("id_hometown_latitude").value = lat;
            document.getElementById("id_hometown_longitude").value = lng;
        });

        // Set initial coordinates
        document.getElementById("id_hometown_latitude").value = defaultLat;
        document.getElementById("id_hometown_longitude").value = defaultLng;
        document.getElementById("id_hometown_name").value = "Kolhapur, Maharashtra, India";

        // Add search functionality
        const searchButton = document.getElementById("search-button");
        const searchInput = document.getElementById("location-search");

        searchButton.addEventListener("click", () => {
            const query = searchInput.value.trim();
            if (query) {
                searchLocation(query);
            }
        });

        searchInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                const query = searchInput.value.trim();
                if (query) {
                    searchLocation(query);
                }
            }
        });
    }

    // Initialize map when page loads
    window.addEventListener('load', initMap);
</script>
{% endblock %}
