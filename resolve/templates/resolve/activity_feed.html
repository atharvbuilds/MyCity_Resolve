{% extends 'resolve/base.html' %}
{% load static %}

{% block title %}Activity Feed{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Activity Feed -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Recent Activity</h4>
                </div>
                <div class="list-group list-group-flush">
                    {% for notification in notifications %}
                    <div class="list-group-item {% if not notification.read %}unread{% endif %}" 
                         id="notification-{{ notification.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <div>
                                <img src="{{ notification.sender.citizenprofile.profile_picture.url|default:'/static/img/default-profile.png' }}" 
                                     alt="{{ notification.sender.username }}"
                                     class="rounded-circle me-2"
                                     width="32" height="32">
                                {{ notification.text }}
                            </div>
                            <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                        </div>
                        {% if not notification.read %}
                        <button class="btn btn-link btn-sm mark-read" 
                                data-notification-id="{{ notification.id }}">
                            Mark as read
                        </button>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="list-group-item text-center">
                        No new activity to show.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Trending Hashtags -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Trending Hashtags</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for hashtag in trending_hashtags %}
                    <a href="{% url 'hashtag_view' tag_name=hashtag.name %}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        #{{ hashtag.name }}
                        <span class="badge bg-primary rounded-pill">{{ hashtag.issue_count }}</span>
                    </a>
                    {% empty %}
                    <div class="list-group-item text-center">
                        No trending hashtags yet.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
const notificationSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/notifications/'
);

notificationSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.action === 'new_notification') {
        // Add new notification to the feed
        const container = document.querySelector('.list-group');
        const template = `
            <div class="list-group-item unread" id="notification-${data.notification_id}">
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <img src="${data.sender_picture || '/static/img/default-profile.png'}" 
                             alt="${data.sender_username}"
                             class="rounded-circle me-2"
                             width="32" height="32">
                        ${data.text}
                    </div>
                    <small class="text-muted">just now</small>
                </div>
                <button class="btn btn-link btn-sm mark-read" 
                        data-notification-id="${data.notification_id}">
                    Mark as read
                </button>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', template);
        
        // Remove "no notifications" message if it exists
        const emptyMessage = container.querySelector('.list-group-item.text-center');
        if (emptyMessage) {
            emptyMessage.remove();
        }
    }
    else if (data.action === 'notification_marked_read') {
        // Update notification appearance
        const notification = document.getElementById(`notification-${data.notification_id}`);
        if (notification) {
            notification.classList.remove('unread');
            const markReadButton = notification.querySelector('.mark-read');
            if (markReadButton) {
                markReadButton.remove();
            }
        }
    }
};

// Handle "Mark as read" buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('mark-read')) {
        const notificationId = e.target.dataset.notificationId;
        notificationSocket.send(JSON.stringify({
            action: 'mark_read',
            notification_id: notificationId
        }));
    }
});
</script>
{% endblock %}
{% endblock %}